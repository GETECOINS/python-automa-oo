from datetime import datetime
import pandas as pd
import time
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.common.by import By
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.support.ui import WebDriverWait
import undetected_chromedriver as webdriver
import requests


#pip install pandas imap-tools selenium webdriver-manager undetected-chromedriver requests




servico = Service(ChromeDriverManager().install())



options = webdriver.ChromeOptions()
options.add_argument(r'user-data-dir=C:\Users\toesc\AppData\Local\Google\Chrome\User Data\Profile 3')
driver = webdriver.Chrome(service=servico, options=options)









tabela = pd.read_csv(r"C:\Users\toesc\Downloads\Planilha sem título - Planilha sem título - Página1(3).csv")#tabela
item_found = None


for linha in tabela.index:    #percore a tabela
    nome_prodt = tabela.loc[linha, "Nome do item"]
    id_genero = tabela.loc[linha, "Categoria"]
    print(nome_prodt)
    if nome_prodt != "IMVU":
        if "avacoins" in id_genero or "crowns" in id_genero:
            codigo = tabela.loc[linha, "codigo"]

            if "male" in id_genero:
                id_item = tabela.loc[linha, "SKU"]
                itens_feminino = requests.post('https://webserver-cryg5idg6q-rj.a.run.app/items?category=all_male&search={}&page=1&language=pt&can_buy_crown_items=true'.format(nome_prodt))
                itens_dic_f = itens_feminino.json()
                # Crie uma lista vazia para armazenar os códigos dos itens
                list_code = []
                
                for i, produto in enumerate(itens_dic_f['items']):
                    code = produto['code']
                    
                    # Adicione o código 'code' a lista 'list_code'
                    list_code.append(code)
                    
                    if id_item in list_code:# Cheque se 'id_item' está em 'list_code'
                        print('encontro')

                        try:    

                                # Se 'id_item' foi encontrado, pegue seu índice e armazene-o em 'item_found'
                            item_found = list_code.index(id_item)
                            driver.get('https://avknstore.netlify.app/gifts')
            
                            # Imprima o índice encontrado
                            print(item_found)
                            
                        
                        
                            try:
                                element = WebDriverWait(driver, 10).until(
                                    EC.presence_of_element_located((By.XPATH, '//*[@id="root"]/div/div[3]/div[1]/div[3]/div[1]/div/div/div/div/div[1]/div[1]/div/input'))
                                )
                                
                                codigo = tabela.loc[linha, "codigo"]
                                print(codigo)

                                time.sleep(4)
                                element.send_keys(codigo)  # CODIGO DE AMIGO
                            except Exception as e:
                                pass
                                print("aqui deu problema")
                                print(str(e)) # imprime a exceção
                            
                            try:
                                element = WebDriverWait(driver, 5).until(
                                    EC.element_to_be_clickable((By.CLASS_NAME, "css-8cynh5"))
                                )
                                element.click()  # ir
                            except:
                                pass
                            time.sleep(3)
                            try:
                                element = WebDriverWait(driver, 5).until(
                                    EC.element_to_be_clickable((By.CLASS_NAME, "css-1f6grfw"))
                                )
                                element.click()
                            except:
                                pass

                            try:
                                time.sleep(1)
                                # Espera até que o elemento seja clicável
                                element = WebDriverWait(driver, 5).until(
                                    EC.element_to_be_clickable((By.XPATH, '//*[@id="root"]/div/div[3]/div[1]/div[3]/div[5]/div[3]/button'))
                                )
                                element.click()  # Clique no elemento

                            except Exception as e:
                                print(f"Ocorreu um erro: {e}")
                                pass

                            try:
                                element = WebDriverWait(driver, 5).until(
                                    EC.element_to_be_clickable((By.CLASS_NAME, "css-putrnr"))
                                )
                                nome_prodt = tabela.loc[linha, "Nome do item"]
                                element.send_keys(nome_prodt)


                            except:
                                pass

                            time.sleep(1)

                            list_elementos = driver.find_elements(By.CLASS_NAME, "MuiAvatar-img")
                            list_elementos[item_found].click()
                            list_elementos[item_found].click()
                            print(len(list_elementos))
                            print(item_found)
                        except Exception as e:
                            print(f"Ocorreu um erro: {e}")
                    
        







